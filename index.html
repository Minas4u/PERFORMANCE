<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Athlete Performance Analyzer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #030712; /* bg-gray-950 */
            color: #f3f4f6; /* text-gray-100 */
        }
        /* Custom scrollbar for month list */
        #monthCheckboxes::-webkit-scrollbar {
            width: 6px;
        }
        #monthCheckboxes::-webkit-scrollbar-track {
            background: #1f2937; /* bg-gray-700 */
            border-radius: 10px;
        }
        #monthCheckboxes::-webkit-scrollbar-thumb {
            background: #374151; /* bg-gray-600 */
            border-radius: 10px;
        }
        #monthCheckboxes::-webkit-scrollbar-thumb:hover {
            background: #4b5563; /* bg-gray-500 */
        }
        
        /* Tab styling */
        .tab-button {
            transition: all 0.2s ease-in-out;
        }
        .tab-button.tab-active {
            color: #ffffff;
            background-color: #06b6d4; /* cyan-500 */
        }
        .tab-button:not(.tab-active) {
            color: #9ca3af; /* gray-400 */
        }
        .tab-button:not(.tab-active):hover {
            background-color: #374151; /* gray-700 */
            color: #ffffff;
        }
    </style>
</head>
<body class="p-4 md:p-8 antialiased bg-gradient-to-b from-gray-950 to-gray-900">

    <div class="max-w-6xl mx-auto">
        <header class="text-center mb-10">
            <h1 class="text-3xl md:text-4xl font-bold bg-gradient-to-r from-cyan-400 to-blue-500 bg-clip-text text-transparent">Athlete Performance Analyzer</h1>
            <p class="text-gray-400 mt-2">Track and Field</p>
        </header>

        <!-- Main Container --><main id="app-container" class="space-y-8">
            
            <!-- Loading/Error State --><div id="statusSection" class="bg-gray-800/50 backdrop-blur-sm border border-gray-700/50 shadow-lg p-6 rounded-xl text-center">
                <p id="statusText" class="flex items-center justify-center space-x-3 text-lg">
                    <svg class="animate-spin h-5 w-5 text-cyan-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    <span>Connecting to Google Sheet...</span>
                </p>
            </div>

            <!-- Controls (hidden by default) --><div id="controlsSection" class="hidden bg-gray-800/50 backdrop-blur-sm border border-gray-700/50 shadow-lg p-6 rounded-xl">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Column 1: Athlete & Gender --><div class="space-y-6">
                        <div>
                            <label for="athleteSearch" class="block mb-2 text-sm font-medium text-gray-300">Athlete</label>
                            <input type="text" id="athleteSearch" list="athleteList" class="w-full bg-gray-700/50 border-gray-600/50 text-white text-sm rounded-lg p-2.5 focus:ring-cyan-500 focus:border-cyan-500" placeholder="Search or select...">
                            <datalist id="athleteList"></datalist>
                        </div>
                        <div>
                            <label class="block mb-2 text-sm font-medium text-gray-300">Gender</label>
                            <div id="genderSelection" class="flex items-center space-x-4 pt-2">
                                <div class="flex items-center">
                                    <input id="gender-male" name="gender" type="radio" value="male" class="w-4 h-4 text-cyan-600 bg-gray-700/50 border-gray-600/50 focus:ring-cyan-600 ring-offset-gray-800" checked>
                                    <label for="gender-male" class="ml-2 text-sm font-medium text-gray-300">Man</label>
                                </div>
                                <div class="flex items-center">
                                    <input id="gender-female" name="gender" type="radio" value="female" class="w-4 h-4 text-cyan-600 bg-gray-700/50 border-gray-600/50 focus:ring-cyan-600 ring-offset-gray-800">
                                    <label for="gender-female" class="ml-2 text-sm font-medium text-gray-300">Woman</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Column 2: Months --><div class="md:col-span-2">
                        <div class="flex justify-between items-center mb-2">
                            <label class="block text-sm font-medium text-gray-300">Months</label>
                            <!-- NEW: Select All/None Buttons --><div class="space-x-2">
                                <button id="selectAllMonths" class="text-xs font-medium text-cyan-400 hover:text-cyan-300">Select All</button>
                                <button id="deselectAllMonths" class="text-xs font-medium text-gray-400 hover:text-gray-300">Select None</button>
                            </div>
                        </div>
                        <div id="monthCheckboxes" class="max-h-40 overflow-y-auto space-y-2 p-3 bg-gray-700/50 rounded-md">
                           <!-- Checkboxes are dynamically inserted here as a vertical list --></div>
                    </div>
                </div>
            </div>

            <!-- Results (hidden by default) --><div id="resultsSection" class="hidden bg-gray-800/50 backdrop-blur-sm border border-gray-700/50 shadow-lg rounded-xl overflow-hidden">
                
                <div class="p-6">
                    <!-- UPDATED: Results header for messages --><h2 id="resultsHeader" class="text-2xl font-semibold mb-6 text-center text-white"></h2>
                </div>
                
                <!-- UPDATED: This container wraps all tab content and can be hidden --><div id="resultsContentContainer">
                    <!-- Tab Navigation --><div class="px-6 border-b border-gray-700">
                        <nav class="flex space-x-2" aria-label="Tabs">
                            <button id="tab-btn-performance" class="tab-button whitespace-nowrap py-2 px-5 rounded-lg text-sm font-medium" data-tab="performance">
                                Athletic Performance
                            </button>
                            <button id="tab-btn-health" class="tab-button whitespace-nowrap py-2 px-5 rounded-lg text-sm font-medium" data-tab="health">
                                Health & Fitness
                            </button>
                            <button id="tab-btn-report" class="tab-button whitespace-nowrap py-2 px-5 rounded-lg text-sm font-medium" data-tab="report">
                                Report
                            </button>
                        </nav>
                    </div>

                    <!-- Tab Content --><div class="p-6">
                        <!-- Performance Tab --><div id="tab-content-performance" class="tab-content">
                            <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
                                <div class="lg:col-span-3">
                                    <h3 class="text-xl font-semibold text-center mb-4">Performance Polygon</h3>
                                    <div class="relative h-[28rem] md:h-[560px]"> <!-- Adjusted height here --><canvas id="performanceChart"></canvas>
                                    </div>
                                </div>
                                <div class="lg:col-span-2">
                                    <h3 class="text-xl font-semibold text-center mb-4">Raw Performance Data</h3>
                                    <div id="performanceStatsContainer" class="space-y-6 max-h-[500px] overflow-y-auto pr-2">
                                        <!-- Performance stats dynamically inserted here --></div>
                                </div>
                            </div>
                        </div>
                        <!-- Health Tab --><div id="tab-content-health" class="tab-content hidden">
                            <div id="healthStatsContainer" class="space-y-6">
                                <!-- Health stats dynamically inserted here --></div>
                        </div>
                        <!-- Report Tab --><div id="tab-content-report" class="tab-content hidden">
                            <div id="reportContainer" class="space-y-6">
                                <!-- Report text dynamically inserted here --></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // --- 1. CONFIGURATION ---
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyHept5BU8WyBZap5YEUwFfKZ28rS4ap7unrZKoSjA9Wph5pVk8Um0rPMvawhrTieDR/exec';
        
        const genderPerformanceConfig = {
            male: {
                '100m':     { min: 19.00, max: 10.50, label: 'ΤΑΧΥΤΗΤΑ' },
                '400m':     { min: 120.0, max: 54.00, label: 'ΑΝΤΟΧΗ ΣΤΗΝ ΤΑΧΥΤΗΤΑ' },
                '1000m':    { min: 345.0, max: 179.0, label: 'ΑΝΤΟΧΗ' },
                'Shot Put': { min: 1.00,  max: 10.50, label: 'ΔΥΝΑΜΗ' },
                'Long Jump':{ min: 1.10,  max: 6.50,  label: 'ΑΛΤΙΚΟΤΗΤΑ' }
            },
            female: {
                '100m':     { min: 20.00, max: 11.50, label: 'ΤΑΧΥΤΗΤΑ' },
                '400m':     { min: 135.0, max: 58.00, label: 'ΑΝΤΟΧΗ ΣΤΗΝ ΤΑΧΥΤΗΤΑ' },
                '1000m':    { min: 360.0, max: 185.0, label: 'ΑΝΤΟΧΗ' },
                'Shot Put': { min: 1.00,  max: 9.00,  label: 'ΔΥΝΑΜΗ' },
                'Long Jump':{ min: 1.00,  max: 5.90,  label: 'ΑΛΤΙΚΟΤΗΤΑ' }
            }
        };

        const healthMetricConfig = {
            colors: {
                blue: '#3b82f6',   // bg-blue-500
                green: '#22c55e', // bg-green-500
                red: '#ef4444'     // bg-red-500
            },
            male: {
                BMI: [
                    { max: 15, color: 'blue' },
                    { max: 80, color: 'green' },
                    { max: Infinity, color: 'red' }
                ],
                'fat%': [
                    { max: 17, color: 'blue' },
                    { max: 25.9, color: 'green' },
                    { max: Infinity, color: 'red' }
                ],
                'Muscle Mass %': [
                    { max: 20.9, color: 'red' },
                    { max: 84.9, color: 'green' },
                    { max: Infinity, color: 'blue' }
                ]
            },
            female: {
                BMI: [
                    { max: 15, color: 'blue' },
                    { max: 80, color: 'green' },
                    { max: Infinity, color: 'red' }
                ],
                'fat%': [
                    { max: 20, color: 'blue' },
                    { max: 29.9, color: 'green' },
                    { max: Infinity, color: 'red' }
                ],
                'Muscle Mass %': [
                    { max: 20.9, color: 'red' },
                    { max: 84.9, color: 'green' },
                    { max: Infinity, color: 'blue' }
                ]
            }
        };

        const polygonLabels = ['ΤΑΧΥΤΗΤΑ', 'ΑΝΤΟΧΗ', 'ΔΥΝΑΜΗ', 'ΑΛΤΙΚΟΤΗΤΑ', 'ΑΝΤΟΧΗ ΣΤΗΝ ΤΑΧΥΤΗΤΑ', 'ΑΘΛΗΤΙΚΟΤΗΤΑ'];
        const comparisonColors = ['#38bdf8', '#fb923c', '#4ade80', '#f87171', '#a78bfa', '#facc15'];

        // --- 2. GLOBAL STATE & DOM ELEMENTS ---
        let appData = {};
        let performanceChartInstance = null;
        const statusSection = document.getElementById('statusSection');
        const statusText = document.getElementById('statusText');
        const controlsSection = document.getElementById('controlsSection');
        const resultsSection = document.getElementById('resultsSection');
        const athleteSearch = document.getElementById('athleteSearch');
        const athleteList = document.getElementById('athleteList');
        const genderSelection = document.getElementById('genderSelection');
        const monthCheckboxes = document.getElementById('monthCheckboxes');
        const performanceStatsContainer = document.getElementById('performanceStatsContainer');
        const healthStatsContainer = document.getElementById('healthStatsContainer');
        const resultsHeader = document.getElementById('resultsHeader');
        const resultsContentContainer = document.getElementById('resultsContentContainer'); // NEW
        const reportContainer = document.getElementById('reportContainer');
        const selectAllMonthsBtn = document.getElementById('selectAllMonths'); // NEW
        const deselectAllMonthsBtn = document.getElementById('deselectAllMonths'); // NEW

        // --- 3. CORE LOGIC ---
        
        /**
         * Converts M:SS or MM:SS strings to total seconds.
         * Also handles numbers (as strings or numbers) already in seconds.
         * @param {string|number} timeString - The time value from the sheet.
         * @returns {number|null} - Total seconds or null if invalid.
         */
        function convertMSToSeconds(timeString) {
            if (typeof timeString !== 'string') {
                // Handle cases where it might already be a number
                const num = parseFloat(String(timeString).replace(',', '.'));
                return isNaN(num) ? null : num;
            }

            const parts = timeString.split(':');
            
            // If it's not in M:SS format, try to parse as float (for 400m, 100m, etc.)
            if (parts.length !== 2) {
                const num = parseFloat(String(timeString).replace(',', '.'));
                return isNaN(num) ? null : num;
            }
            
            const minutes = parseInt(parts[0], 10);
            const seconds = parseInt(parts[1], 10);
            
            if (isNaN(minutes) || isNaN(seconds)) return null; // Invalid format
            
            return (minutes * 60) + seconds;
        }

        async function fetchData() {
            const proxyUrl = 'https://corsproxy.io/?';
            try {
                const response = await fetch(`${proxyUrl}${GOOGLE_SCRIPT_URL}`);
                if (!response.ok) throw new Error(`Network error: ${response.statusText}`);
                const text = await response.text();
                
                if (text.trim().startsWith('<')) {
                    throw new Error('Received HTML instead of JSON. Please check the Google Apps Script deployment permissions. It should be deployed as a Web App with access set to "Anyone".');
                }

                appData = JSON.parse(text);
                if (Object.keys(appData).length === 0) throw new Error('Received empty data object, but the connection was successful. Make sure the Google Sheet has data.');
                initializeControls();
            } catch (error) {
                console.error('Initialization failed:', error);
                statusText.innerHTML = `<span class="text-red-400"><strong>Connection Failed:</strong> ${error.message}</span>`;
            }
        }
        
        function initializeControls() {
            const athletes = new Set();
            Object.values(appData).flat().forEach(a => {
                if (a && a.Name && a.Surname) athletes.add(`${a.Name} ${a.Surname}`);
            });
            
            Array.from(athletes).sort().forEach(name => {
                athleteList.innerHTML += `<option value="${name}"></option>`;
            });

            // Re-styling month selection to a vertical list
            monthCheckboxes.innerHTML = ''; // Clear previous grid
            Object.keys(appData).forEach((month, index) => {
                monthCheckboxes.innerHTML += `
                    <div class="flex items-center p-1">
                        <input id="month-${index}" type="checkbox" value="${month}" class="w-4 h-4 text-cyan-600 bg-gray-700/50 border-gray-500/50 rounded focus:ring-cyan-600 ring-offset-gray-900">
                        <label for="month-${index}" class="ml-2 text-sm font-medium text-gray-300">${month}</label>
                    </div>`;
            });

            statusSection.classList.add('hidden');
            controlsSection.classList.remove('hidden');

            // Add event listeners
            athleteSearch.addEventListener('input', updateDisplay);
            genderSelection.addEventListener('change', updateDisplay);
            monthCheckboxes.addEventListener('change', updateDisplay);
            
            // NEW: Listeners for select all/none
            selectAllMonthsBtn.addEventListener('click', () => {
                monthCheckboxes.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
                updateDisplay();
            });
            deselectAllMonthsBtn.addEventListener('click', () => {
                monthCheckboxes.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
                updateDisplay();
            });

            initializeTabs();
            updateDisplay(); // Initial call to show "Please select..." message
        }

        /**
         * REFACTORED: Initializes tab switching logic using classList.
         */
        function initializeTabs() {
            const tabs = document.querySelectorAll('.tab-button');
            const contents = document.querySelectorAll('.tab-content');
            
            // Set initial active state
            tabs[0].classList.add('tab-active');
            contents[0].classList.remove('hidden');

            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const target = tab.getAttribute('data-tab');
                    
                    // Update tab button styles
                    tabs.forEach(t => t.classList.remove('tab-active'));
                    tab.classList.add('tab-active');
                    
                    // Show/hide tab content
                    contents.forEach(c => {
                        if (c.id === `tab-content-${target}`) {
                            c.classList.remove('hidden');
                        } else {
                            c.classList.add('hidden');
                        }
                    });
                });
            });
        }

        /**
         * UPDATED: Main function to update all UI elements,
         * now includes better feedback messages.
         */
        function updateDisplay() {
            const selectedAthlete = athleteSearch.value;
            const selectedGender = document.querySelector('input[name="gender"]:checked').value;
            const selectedMonths = Array.from(monthCheckboxes.querySelectorAll('input:checked')).map(cb => cb.value);

            // Show the results section card
            resultsSection.classList.remove('hidden');

            if (!selectedAthlete || selectedMonths.length === 0) {
                resultsHeader.textContent = 'Please select an athlete and at least one month.';
                resultsContentContainer.classList.add('hidden'); // Hide tabs and charts
                return;
            }

            performanceStatsContainer.innerHTML = '';
            healthStatsContainer.innerHTML = '';
            reportContainer.innerHTML = '';
            const datasets = [];

            selectedMonths.forEach((month, index) => {
                if (appData[month] && Array.isArray(appData[month])) {
                    const athleteData = appData[month].find(a => a && `${a.Name} ${a.Surname}` === selectedAthlete);
                    if (athleteData) {
                        const polygonData = calculatePolygonData(athleteData, selectedGender); // Calculate data once
                        
                        // --- NEW: Calculate Health Metrics for Report ---
                        const height = parseFloat(String(athleteData['Height']).replace(',', '.'));
                        const weight = parseFloat(String(athleteData['kg']).replace(',', '.'));
                        const fatPercent = parseFloat(String(athleteData['fat%']).replace(',', '.'));
                        const muscleMass = parseFloat(String(athleteData['Muscle Mass'] || athleteData['Muscle']).replace(',', '.'));
                        
                        let bmi = null;
                        if (height && weight && height > 0) {
                            const heightInMeters = height / 100; // Assuming height is in CM
                            bmi = (weight / (heightInMeters * heightInMeters)).toFixed(2);
                        }
                        
                        let musclePercent = null;
                        if (muscleMass && weight && weight > 0) {
                            musclePercent = ((muscleMass / weight) * 100).toFixed(2);
                        }

                        const healthReportData = {
                            'BMI': { 
                                value: bmi, 
                                color: isNaN(bmi) ? null : getHealthBarDetails('BMI', bmi, selectedGender, 100).barColor
                            },
                            'fat%': {
                                value: fatPercent,
                                color: isNaN(fatPercent) ? null : getHealthBarDetails('fat%', fatPercent, selectedGender, 50).barColor
                            },
                            'Muscle Mass %': {
                                value: musclePercent,
                                color: isNaN(musclePercent) ? null : getHealthBarDetails('Muscle Mass %', musclePercent, selectedGender, 100).barColor
                            }
                        };
                        // --- END NEW ---
                        
                        datasets.push({
                            label: month,
                            data: polygonData, // Use pre-calculated data
                            borderColor: comparisonColors[index % comparisonColors.length],
                            backgroundColor: `${comparisonColors[index % comparisonColors.length]}33`,
                            pointBackgroundColor: comparisonColors[index % comparisonColors.length],
                            borderWidth: 4, // Make line thicker
                            pointRadius: 0, // Make points invisible by default
                            pointHoverRadius: 7, // Make points pop on hover
                            tension: 0 // Make lines straight (sharp corners)
                        });
                        displayPerformanceStats(athleteData, month, comparisonColors[index % comparisonColors.length]);
                        displayHealthStats(athleteData, month, comparisonColors[index % comparisonColors.length], selectedGender);
                        displayReport(polygonData, healthReportData, month, comparisonColors[index % comparisonColors.length]); // Create report
                    }
                }
            });

            // NEW: Check if any data was actually found
            if (datasets.length === 0) {
                resultsHeader.textContent = `No data found for ${selectedAthlete} in the selected month(s).`;
                resultsContentContainer.classList.add('hidden'); // Hide tabs and charts
            } else {
                resultsHeader.textContent = `Displaying results for ${selectedAthlete}`;
                resultsContentContainer.classList.remove('hidden'); // Show tabs and charts
                renderChart(datasets);
            }
        }
        
        /**
         * UPDATED: Uses convertMSToSeconds for 100m, 400m, and 1000m
         * for robust parsing.
         */
        function calculatePolygonData(athleteData, gender) {
            const performanceConfig = genderPerformanceConfig[gender];
            if (!performanceConfig) return polygonLabels.map(() => 0); // Safety check

            const scores = {};
            for (const [key, config] of Object.entries(performanceConfig)) {
                if (athleteData[key] === undefined || athleteData[key] === '') continue;
                
                let value;
                // UPDATED: Use robust converter for all time-based events
                if (key === '1000m' || key === '400m' || key === '100m') {
                    value = convertMSToSeconds(athleteData[key]);
                } else {
                    // Use standard parsing for non-time events (Shot Put, Long Jump)
                    value = parseFloat(String(athleteData[key]).replace(',', '.'));
                }
                
                if (value === null || isNaN(value)) continue;

                const score = (config.min > config.max)
                    ? 10 * (config.min - value) / (config.min - config.max)
                    : 10 * (value - config.min) / (config.max - config.min);
                
                scores[config.label] = Math.max(0, Math.min(10, score));
            }
            
            // --- UPDATED AΘΛΗΤΙΚΟΤΗΤΑ CALCULATION ---
            let athleticScore = 0;
            Object.values(scores).forEach(score => {
                if (score > 7) {
                    athleticScore += 2; // Add 2 points if score is > 7
                } else if (score > 4) {
                    athleticScore += 1; // Add 1 point if score is > 4
                }
                // If score is 4 or less, add 0 points
            });
            // --- END OF UPDATE ---
            
            return polygonLabels.map(label => label === 'ΑΘΛΗΤΙΚΟΤΗΤΑ' ? athleticScore : (scores[label] || 0));
        }
        
        function renderChart(datasets) {
            const ctx = document.getElementById('performanceChart').getContext('2d');
            if (performanceChartInstance) performanceChartInstance.destroy();
            performanceChartInstance = new Chart(ctx, {
                type: 'radar',
                data: { labels: polygonLabels, datasets: datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            angleLines: { color: 'rgba(255, 255, 255, 0.2)' },
                            grid: { 
                                color: function(context) {
                                    if (context.tick.value === 3) {
                                        return '#ef4444'; // Red-500
                                    } else if (context.tick.value === 5) {
                                        return '#22c55e'; // Green-500
                                    } else if (context.tick.value === 8) {
                                        return '#facc15'; // Amber-400 (Yellow)
                                    } else if (context.tick.value === 10) {
                                        return '#3b82f6'; // Blue-500
                                    }
                                    return 'rgba(255, 255, 255, 0.2)'; // Default grid color
                                },
                                lineWidth: function(context) {
                                    if ([3, 5, 8, 10].includes(context.tick.value)) {
                                        return 2; // Thicker line for benchmarks
                                    }
                                    return 1; // Default line width
                                }
                            },
                            pointLabels: { color: '#f3f4f6', font: { size: 12 } },
                            ticks: {
                                display: false, // This hides the numbers (0, 1, 2... 10)
                                color: '#f3f4f6', backdropColor: 'rgba(0,0,0,0.5)', stepSize: 1,
                            },
                            suggestedMin: 0, suggestedMax: 10
                        }
                    },
                    plugins: {
                        legend: { labels: { color: '#f3f4f6' } }
                    }
                }
            });
        }

        // Helper function to format seconds into M:SS
        function formatSecondsToMS(totalSeconds) {
            if (isNaN(totalSeconds)) return 'N/A';
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = (totalSeconds % 60).toFixed(0);
            return `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        function displayPerformanceStats(data, month, color) {
            const perfKeys = ['100m', '400m', '1000m', 'Shot Put', 'Long Jump'];
            let statsHtml = `
                <div class="bg-gray-900/70 p-4 rounded-lg border border-cyan-500/30 shadow-lg">
                    <h4 class="text-lg font-bold" style="color: ${color};">${month}</h4>
                    <div class="mt-2 grid grid-cols-2 gap-x-4 gap-y-1 text-sm">`;

            perfKeys.forEach(key => {
                const rawValue = data[key] ? String(data[key]).replace(',', '.') : 'N/A';
                let value = rawValue;

                // Format 400m from seconds to M:SS
                if (key === '400m' && rawValue !== 'N/A') {
                    const numSeconds = parseFloat(rawValue);
                    value = formatSecondsToMS(numSeconds);
                }
                
                statsHtml += `<div><strong class="text-gray-400">${key}:</strong> ${value}</div>`;
            });
            
            statsHtml += `</div></div>`;
            performanceStatsContainer.innerHTML += statsHtml;
        }

        function displayHealthStats(data, month, color, gender) {
            const healthKeys = ['Height', 'kg', 'fat%', 'Muscle Mass', 'Muscle'];
            
            const height = parseFloat(String(data['Height']).replace(',', '.'));
            const weight = parseFloat(String(data['kg']).replace(',', '.'));
            const fatPercent = parseFloat(String(data['fat%']).replace(',', '.'));
            const muscleMass = parseFloat(String(data['Muscle Mass'] || data['Muscle']).replace(',', '.'));
            
            let bmi = null;
            if (height && weight && height > 0) {
                const heightInMeters = height / 100; // Assuming height is in CM
                bmi = (weight / (heightInMeters * heightInMeters)).toFixed(2);
            }
            
            let musclePercent = null;
            if (muscleMass && weight && weight > 0) {
                musclePercent = ((muscleMass / weight) * 100).toFixed(2);
            }

            const metrics = {
                'BMI': { value: bmi, max: 100 }, // Using 100 as max for BMI bar
                'fat%': { value: fatPercent, max: 50 }, // Using 50 as max for Fat% bar
                'Muscle Mass %': { value: musclePercent, max: 100 } // Using 100 as max for Muscle % bar
            };

            let statsHtml = `<div class="bg-gray-900/70 p-4 rounded-lg border border-cyan-500/30 shadow-lg">
                <h4 class="text-lg font-bold mb-4" style="color: ${color};">${month}</h4>
                <div class="space-y-4">`;

            // Render bars
            for (const [key, { value, max }] of Object.entries(metrics)) {
                if (value !== null && !isNaN(value)) {
                    const { barColor, barWidth } = getHealthBarDetails(key, value, gender, max);
                    statsHtml += `
                        <div>
                            <div class="flex justify-between mb-1">
                                <span class="text-sm font-medium text-gray-300">${key}</span>
                                <span class="text-sm font-medium" style="color: ${barColor};">${value}${key.includes('%') ? '%' : ''}</span>
                            </div>
                            <div class="w-full bg-gray-700/50 rounded-full h-2.5">
                                <div class="bg-blue-500 h-2.5 rounded-full transition-all duration-300" style="width: ${barWidth}%; background-color: ${barColor};"></div>
                            </div>
                        </div>`;
                }
            }
            
            // Render raw health data
            statsHtml += `<div class="pt-4 border-t border-gray-700/50 mt-4 grid grid-cols-2 gap-x-4 gap-y-1 text-sm">`;
            healthKeys.forEach(key => {
                if (data[key]) {
                    const value = String(data[key]).replace(',', '.');
                    statsHtml += `<div><strong class="text-gray-400">${key}:</strong> ${value}</div>`;
                }
            });
            statsHtml += `</div></div></div>`;
            healthStatsContainer.innerHTML += statsHtml;
        }

        function getHealthBarDetails(metric, value, gender, max) {
            const config = healthMetricConfig[gender][metric];
            let barColor = healthMetricConfig.colors.green; // Default
            
            if (config) {
                for (const range of config) {
                    if (value <= range.max) {
                        barColor = healthMetricConfig.colors[range.color];
                        break;
                    }
                }
            }
            
            const barWidth = Math.min(100, (value / max) * 100);
            return { barColor, barWidth };
        }

        // --- NEW FUNCTIONS FOR REPORT ---

        /**
         * Translates a numeric score into a descriptive text and color.
         * @param {number} score - The numeric score (0-10).
         * @param {string} label - The label for the metric (e.g., "ΔΥΝΑΜΗ").
         * @returns {object} - An object with { text, color }.
         */
        function getReportText(score, label) {
            // --- FIX: Added the missing logic ---
            if (score <= 3) {
                return { text: `ΜΕΙΩΜΕΝΗ ${label}`, color: '#ef4444' }; // Red
            } else if (score <= 5) {
                return { text: `ΚΑΝΟΝΙΚΗ ${label}`, color: '#22c55e' }; // Green
            } else if (score <= 8) {
                return { text: `ΥΨΗΛΗ ${label}`, color: '#facc15' }; // Yellow
            } else {
                return { text: `ΚΟΡΥΦΑΙΑ ${label}`, color: '#3b82f6' }; // Blue
            }
        }

        /**
         * Generates and displays the report for a single month.
         * @param {number[]} polygonData - Array of scores from the polygon.
         * @param {object} healthReportData - Object with BMI, fat%, Muscle Mass % values and colors.
         * @param {string} month - The name of the month.
         * @param {string} color - The color associated with the month.
         */
        function displayReport(polygonData, healthReportData, month, color) {
            
            // --- 1. Health Metric Translations ---
            const healthTranslations = {
                BMI: {
                    [healthMetricConfig.colors.blue]: 'ΕΛΛΙΠΟΒΑΡΗΣ',
                    [healthMetricConfig.colors.green]: 'ΦΥΣΙΟΛΟΓΙΚΟ ΒΑΡΟΣ',
                    [healthMetricConfig.colors.red]: 'ΧΡΕΙΑΖΕΤΑΙ ΠΡΟΣΟΧΗ ΣΤΟ ΒΑΡΟΣ'
                },
                'fat%': {
                    [healthMetricConfig.colors.blue]: 'ΑΡΙΣΤΟ ΣΩΜΑΤΙΚΟ ΛΙΠΟΣ',
                    [healthMetricConfig.colors.green]: 'ΦΥΣΙΟΛΟΓΙΚΟ ΣΩΜΑΤΙΚΟ ΛΙΠΟΣ',
                    [healthMetricConfig.colors.red]: 'ΧΡΕΙΑΖΕΤΑΙ ΠΡΟΣΟΧΗ ΣΤΟ ΛΙΠΟΣ'
                },
                'Muscle Mass %': {
                    [healthMetricConfig.colors.blue]: 'ΧΡΕΙΑΖΕΤΑΙ ΕΝΔΥΝΑΜΩΣΗ',
                    [healthMetricConfig.colors.green]: 'ΦΥΣΙΟΛΟΓΙΚΗ ΜΥΙΚΗ ΜΑΖΑ',
                    [healthMetricConfig.colors.red]: 'ΥΨΗΛΗ ΜΥΙΚΗ ΜΑΖΑ'
                }
            };
            
            // --- 2. Build Performance List Items ---
            const performanceItems = polygonLabels.map((label, index) => {
                const score = polygonData[index];
                const { text, color: textColor } = getReportText(score, label);
                return `<li><span class="font-medium" style="color: ${textColor};">${text}</span></li>`;
            }).join('');

            // --- 3. Build Health List Items ---
            const { BMI, 'fat%': fat, 'Muscle Mass %': muscle } = healthReportData;
            let healthItems = '';

            if (BMI && BMI.color) {
                const text = healthTranslations.BMI[BMI.color] || 'BMI (No Data)';
                healthItems += `<li><span class="font-medium" style="color: ${BMI.color};">${text}</span></li>`;
            }
            if (fat && fat.color) {
                const text = healthTranslations['fat%'][fat.color] || 'Fat% (No Data)';
                healthItems += `<li><span class="font-medium" style="color: ${fat.color};">${text}</span></li>`;
            }
            if (muscle && muscle.color) {
                const text = healthTranslations['Muscle Mass %'][muscle.color] || 'Muscle% (No Data)';
                healthItems += `<li><span class="font-medium" style="color: ${muscle.color};">${text}</span></li>`;
            }

            // --- 4. Build Final HTML ---
            const reportHtml = `
                <div class="bg-gray-900/70 p-4 rounded-lg border border-cyan-500/30 shadow-lg">
                    <h4 class="text-lg font-bold" style="color: ${color};">${month}</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
                        
                        <!-- Athletic Performance Card --><div class="bg-gray-800/50 p-4 rounded-lg border border-gray-700">
                            <h5 class="text-base font-semibold text-gray-300 mb-1">Athletic Performance</h5>
                            <ul class="list-disc list-inside space-y-1 text-sm">
                                ${performanceItems}
                            </ul>
                        </div>
                        
                        <!-- Health & Fitness Card --><div class="bg-gray-800/50 p-4 rounded-lg border border-gray-700">
                            <h5 class="text-base font-semibold text-gray-300 mb-1">Health & Fitness</h5>
                            <ul class="list-disc list-inside space-y-1 text-sm">
                                ${healthItems}
                            </ul>
                        </div>
                    </div>
                </div>`;

            reportContainer.innerHTML += reportHtml;
        }

        // --- 4. INITIALIZATION ---
        window.addEventListener('DOMContentLoaded', fetchData);
    </script>

</body>
</html>

